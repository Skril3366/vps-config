# Authelia authentication portal
{% if domain_name != "YOUR_DOMAIN_OR_IP" %}
auth.{{ domain_name }} {
{% else %}
:9092 {
{% endif %}
    reverse_proxy 127.0.0.1:{{ authelia_port }}
}

# Grafana dashboard
{% if domain_name != "YOUR_DOMAIN_OR_IP" %}
grafana.{{ domain_name }} {
{% else %}
:3001 {
{% endif %}
    forward_auth 127.0.0.1:{{ authelia_port }} {
        uri /api/verify?rd=https://auth.{{ domain_name }}
        copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
    }
    reverse_proxy 127.0.0.1:{{ grafana_port }}
}

# Prometheus metrics
{% if domain_name != "YOUR_DOMAIN_OR_IP" %}
prometheus.{{ domain_name }} {
{% else %}
:9091 {
{% endif %}
    forward_auth 127.0.0.1:{{ authelia_port }} {
        uri /api/verify?rd=https://auth.{{ domain_name }}
        copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
    }
    reverse_proxy 127.0.0.1:{{ prometheus_port }}
}

# Loki logs
{% if domain_name != "YOUR_DOMAIN_OR_IP" %}
loki.{{ domain_name }} {
{% else %}
:3101 {
{% endif %}
    forward_auth 127.0.0.1:{{ authelia_port }} {
        uri /api/verify?rd=https://auth.{{ domain_name }}
        copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
    }
    reverse_proxy 127.0.0.1:{{ loki_port }}
}

# Main domain - serve personal website
{% if domain_name != "YOUR_DOMAIN_OR_IP" %}
{{ domain_name }} {
{% else %}
:80 {
{% endif %}
    reverse_proxy 127.0.0.1:{{ personal_website_port }}
}

# Projects subdomain with path-based routing
{% if domain_name != "YOUR_DOMAIN_OR_IP" %}
projects.{{ domain_name }} {
{% else %}
:8080 {
{% endif %}
{% for project in projects %}
    # Redirect project path without trailing slash to add trailing slash
    redir /{{ project.name }} /{{ project.name }}/ permanent
    
    # Handle main app page
    handle /{{ project.name }}/* {
        uri strip_prefix /{{ project.name }}
        reverse_proxy 127.0.0.1:{{ project.port }}
    }
    
    # Handle any absolute paths from {{ project.name }} (based on referer)
    @{{ project.name }}_assets {
        header Referer *{{ project.name }}*
        not path /{{ project.name }}/*
    }
    handle @{{ project.name }}_assets {
        reverse_proxy 127.0.0.1:{{ project.port }}
    }
{% endfor %}
}